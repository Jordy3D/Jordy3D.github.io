<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterDex Challenge</title>
    <style>
        html {
            font-family: Arial, Helvetica, sans-serif;

            background-color: #7fac71;
            background-image: url("https://wallpapercave.com/wp/wp1902707.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: left top;
            image-rendering: pixelated;

            height: 100vh;
            overflow: hidden;
            overflow-y: scroll;
        }

        * {
            box-sizing: border-box;
        }

        #app {
            display: flex;
            flex-direction: column;
            align-items: center;

            height: fit-content;
        }

        #app header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1;

            background: lightblue;
            box-shadow: 2px 2px black;

            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
        }

        #app header.sticky {
            position: fixed;
        }

        #app .description {
            margin-top: 5.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;

            width: 80%;
            max-width: 800px;

            background: #eee;
            border: 1px solid black;
            border-radius: 0.5rem;
            box-shadow: 2px 2px black;
            
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .box {
            display: flex;
            flex-wrap: wrap;

            justify-content: center;

            max-width: 1400px;
            margin: 0 auto;

            gap: 0.5rem;

            padding-bottom: 3rem;

            /* similar to above, but using grid with 6 columns */
            display: grid;
            grid-template-rows: 3em 1fr;
            grid-template-columns: repeat(6, 1fr);
        }

        .box.closed {
            height: 3em;
            overflow: hidden;

            margin-bottom: 0.5rem;
        }

        .box-header {
            grid-column: 1 / 7;
            grid-row: 1 / 2;

            text-align: center;

            background: #eee;
            border: 1px solid black;
            border-radius: 0.5rem;
            box-shadow: 2px 2px black;

            padding: 0.5rem;

            font-size: 1.5rem;
            font-weight: bold;
        }

        .box-header:hover {
            background: lightblue;
            box-shadow: 4px 4px black;
        }

        .box-header::after {
            content: "▼";
            float: right;
        }

        .box.closed .box-header {
            box-shadow: none;

            background: #cacaca;
        }

        .box.closed .box-header::after {
            content: "◀";

        }

        /* hide boxes with no filtered pokemon */
        #data.filtered .box:not(:has(.found)) {
            display: none;
        }

        /* set boxes to not take up as many rows */
        #data.filtered .box {
            grid-template-rows: 3em 1fr;
        }

        .pokemon {
            border: 1px solid black;
            border-radius: 0.5rem;

            background: #eee;

            /* width: 200px;
            height: 200px; */
            aspect-ratio: 1 / 1;

            display: grid;
            grid-template-areas:
                "header"
                "game"
                "notes"
                "toggle";

            box-shadow: 2px 2px black;

            overflow: hidden;

            transition: 100ms;
        }

        .pokemon p {
            margin: 0;
        }

        .pokemon .header {
            grid-area: header;

            display: flex;
            justify-content: space-between;

            width: 100%;
            padding: 0.5rem;

            background: #cacaca;
        }

        .pokemon .name,
        .pokemon .dex {
            margin: 0;
        }

        .pokemon .notes {
            grid-area: notes;
        }

        .pokemon .game {
            grid-area: game;
            padding: 0.5rem;
        }

        .pokemon .game .title {
            margin: 0;
        }

        .pokemon .notes {
            grid-area: notes;
            padding: 0.5rem;
        }

        .pokemon.outlier {
            /* give a gold border and box-shadow */
            border: 1px solid gold;
            box-shadow: 2px 2px gold;

            background-color: #f5f5dc;
        }

        .pokemon.outlier .header {
            background-color: #d6d6a0;
        }

        .pokemon.outlier:hover {
            box-shadow: 4px 4px gold;
        }

        .pokemon:hover {
            background: lightblue;
            box-shadow: 4px 4px black;

            transform: scale(1.2);
        }

        .pokemon:hover .header {
            background: blue;
            color: azure;
        }


        /* caught */
        .pokemon.caught {
            background: lightgreen;
        }

        .pokemon.caught .header {
            background: green;
            color: azure;
        }

        /* mobile? */
        @media (max-width: 835px) {
            #app header {
                flex-direction: column;
                padding-bottom: 1rem;
            }

            #app header h1 {
                margin: 1rem;
            }

            #app .description {
                margin-top: 8.5rem;
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <header>
            <h1>Pokémon MasterDex Challenge</h1>
            <div id="buttons">
                <button onclick="saveToStorage()">Save</button>
                <button onclick="exportToJSON()">Export</button>
                <button onclick="importFromJSON()">Import</button>
            </div>

            <input type="text" id="filter" onkeyup="filter()" placeholder="Search in data...">
        </header>

        <div class="description">
            <div class="details">
                <h3 style="text-align: center;">Details</h3>
                <hr>
                <p>This is an interactive page that allows you to keep track of which Pokémon you have caught the Pokémon MasterDex Challenge.</p>
                <h4>Functions</h4>
                <ul>
                    <li>Toggle whether or not you have caught a Pokémon by clicking on it.</li>
                    <li>Save your progress to your browser's localstorage.</li>
                    <li>Export and Import your progress to a JSON file.</li>
                    <li>Search for a Pokémon by typing in the search bar.</li>
                </ul>
                <h4>Key</h4>
                <ul>
                    <li>Grey Pokémon have not been caught.</li>
                    <li>Green Pokémon have been caught.</li>
                    <li>Yellow Pokémon are outliers. These are Pokémon that are not obtained in a normal way, or are very specific.</li>
                </ul>
            </div>
            <div class="notes">
                <h3 style="text-align: center;">Notes</h3>
                <hr>
                <ul>
                    <li>
                        This page is still in development, so there may be bugs. If you find any, please let me know on
                        <a href="jordy3d.github.io">my GitHub page</a>.
                    </li>
                    <li>
                        This page is not affiliated with Nintendo, Game Freak, or The Pokémon Company in any way.
                    </li>
                    <li>
                        This page makes use of localstorage. If you clear your browser's cache, your progress will be
                        lost
                        unless you have previously exported your progress.
                    </li>
                    <li>
                        Much of the data used on this page is from Bird Keeper Toby's spreadsheet. You can find the most
                        recent video about the MasterDex Challenge <a
                            href="https://www.youtube.com/watch?v=dKOjYQ5fhQQ">here</a>.
                    </li>
                    <li>
                        The Konami Code will clear localstorage and reload the page.
                    </li>
                    <li>
                        At the time of writing, Paldea is not included in the MasterDex Challenge as it is not supported
                        by HOME. The information below is my best guess as to what may be included in the future.
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div id="data"></div>

    <script>

        // make the header sticky when scrolling
        window.onscroll = function () {
            var header = document.querySelector("header");
            var sticky = header.offsetTop;

            if (window.pageYOffset > sticky) {
                header.classList.add("sticky");
            } else {
                header.classList.remove("sticky");
            }
        };

        // listen to the konami code, up up down down left right left right b a
        var konami = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
        var konami_index = 0;
        document.addEventListener('keydown', function (e) {
            if (e.keyCode == konami[konami_index]) {
                konami_index++;
                if (konami_index == konami.length) {
                    konami_index = 0;
                    // clear local storage
                    localStorage.clear();
                    // reload the page
                    location.reload();
                }
            } else {
                konami_index = 0;
            }
        });

        var full_json = null;

        loadJSON();

        loadFromStorage();

        function loadJSON() {
            fetch('masterdex/pokemon.json')
                .then(response => response.json())
                .then(json => {
                    full_json = json;

                    // calculate how many boxes we need
                    var boxes = Math.ceil(json.length / 30);
                    // create a div for each box
                    for (var i = 0; i < boxes; i++) {
                        createBox(i + 1);
                    }

                    for (var i = 0; i < json.length; i++) {
                        // create a div for each pokemon
                        createDiv(json[i]);

                    }
                });
        }

        function saveToStorage() {
            // check the checkboxes for each pokemon that has been caught
            for (var i = 0; i < full_json.length; i++) {
                if (document.getElementById(full_json[i].name).classList.contains("caught")) {
                    full_json[i].obtained = true;
                    console.log(`caught ${full_json[i].name}`);
                }
                else {
                    full_json[i].obtained = false;
                }
            }

            localStorage.setItem("pokemon", JSON.stringify(full_json));

            full_json = JSON.parse(localStorage.getItem("pokemon"));

            // print the first pokemon in the list
            console.log(full_json[0]);

        }

        function loadFromStorage() {
            // see if all of the divs have been created
            if (full_json == null) {
                setTimeout(loadFromStorage, 100);
                return;
            }

            // load from local storage if it exists
            if (localStorage.getItem("pokemon") != null) {
                stored_json = JSON.parse(localStorage.getItem("pokemon"));
                for (var i = 0; i < stored_json.length; i++) {
                    if (stored_json[i].obtained) {
                        let pokemon_name = stored_json[i].name;
                        // replace spaces with dashes
                        pokemon_name = pokemon_name.replace(" ", "-");

                        let pokemon = document.querySelector("#" + pokemon_name);

                        if (pokemon != null) {
                            console.log(`Setting ${stored_json[i].name} to caught`);
                            pokemon.classList.add("caught");
                        }
                        else {
                            console.log(`Could not find ${stored_json[i].name}`);
                        }
                    }
                }
                full_json = stored_json;
            }

        }

        // create a div for each box
        function createBox(box_number) {
            // the box will contain 30 pokemon

            // create the box
            var box = document.createElement("div");
            box.id = "box" + box_number;
            box.className = "box";

            // create the header
            var header = document.createElement("div");
            header.className = "box-header";
            header.innerHTML = "Box " + box_number;
            box.appendChild(header);

            // add event listeners to the header to toggle the box open and closed
            header.addEventListener("click", function () {
                box.classList.toggle("closed");
            });

            document.getElementById("data").appendChild(box);
        }

        // create a div for each pokemon
        function createDiv(pokemon) {
            // the div will contain the pokemon name, dex number, the game it is to be found in, any notes, and a toggle to mark it as caught

            // calculate what box the pokemon should be in
            var box = Math.floor((pokemon.dex_number - 1) / 30) + 1;

            // create the div
            var div = document.createElement("div");
            div.id = pokemon.name.replace(" ", "-");
            div.className = "pokemon";

            var header = document.createElement("div");
            header.classList.add("header");
            div.appendChild(header);

            // create the name
            var name = document.createElement("h2");
            name.classList.add("name");
            name.innerHTML = pokemon.name;
            header.appendChild(name);

            // create the dex number
            var dex = document.createElement("p");
            dex.classList.add("dex");
            dex.innerHTML = pokemon.dex_number;
            header.appendChild(dex);

            // create the game requirements
            var gameSection = document.createElement("div");
            gameSection.classList.add("game")
            div.appendChild(gameSection);

            var gameLabel = document.createElement("p");
            gameLabel.innerHTML = "Source:";
            gameSection.appendChild(gameLabel);

            var game = document.createElement("ul");
            game.classList.add("title");
            for (var i = 0; i < pokemon.requirements.length; i++) {
                var li = document.createElement("li");
                li.innerHTML = pokemon.requirements[i];
                game.appendChild(li);
            }
            gameSection.appendChild(game);

            // create the notes
            var notes = document.createElement("p");
            notes.classList.add("notes");
            notes.innerHTML = pokemon.notes;
            div.appendChild(notes);

            // if pokemon is an outlier, add the outlier class
            if (pokemon.outlier) {
                div.classList.add("outlier");
            }

            // create the toggle
            div.addEventListener("click", function (event) {
                toggleCaught(pokemon.name);
            });

            div.addEventListener("contextmenu", function (event) {
                event.preventDefault();
                // notes.style.display = notes.style.display == "none" ? "block" : "none";
            });

            // add the div to the box
            document.getElementById("box" + box).appendChild(div);
        }

        function toggleCaught(name) {
            var div = document.getElementById(name);
            div.classList.toggle("caught");

            // toggle the status of the pokemon in the json
            for (var i = 0; i < full_json.length; i++) {
                if (full_json[i].name == name)
                    full_json[i].obtained = !full_json[i].obtained;
            }
        }

        function filter() {
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById("filter");
            filter = input.value.toLowerCase();

            // if the filter is empty, show all pokemon
            if (filter == "") {
                var divs = document.getElementsByClassName("pokemon");
                for (i = 0; i < divs.length; i++) {
                    divs[i].style.display = "";
                    divs[i].classList.remove("found");
                    document.getElementById("data").classList.remove("filtered");
                }
                return;
            }

            var divs = document.getElementsByClassName("pokemon");

            // mark the #data div as filtered
            document.getElementById("data").classList.add("filtered");

            // set all divs to display none
            for (i = 0; i < divs.length; i++) {
                divs[i].style.display = "none";
                divs[i].classList.remove("found");
            }

            for (i = 0; i < divs.length; i++) {
                if (divs[i].id.toLowerCase().includes(filter) || divs[i].getElementsByClassName("notes")[0].innerHTML.toLowerCase().includes(filter) || divs[i].getElementsByClassName("dex")[0].innerHTML.toLowerCase().includes(filter) || divs[i].getElementsByClassName("game")[0].innerHTML.toLowerCase().includes(filter)) {
                    divs[i].style.display = "";
                    // unclose any boxes that contain the filtered pokemon
                    divs[i].parentElement.classList.remove("closed");
                    divs[i].parentElement.getElementsByClassName("box-header")[0].classList.remove("closed");
                    // mark the pokemon as "found"
                    divs[i].classList.add("found");
                } else {
                    divs[i].style.display = "none";
                }
            }
        }

        function exportToJSON() {

            // remove the "caught" property from the json, cuz it was messing me up a few times
            if (full_json[0].hasOwnProperty("caught")) {
                for (var i = 0; i < full_json.length; i++)
                    delete full_json[i].caught;
            }

            // stringify the json with an indent of 4 spaces
            var dataStr = JSON.stringify(full_json, null, 4);
            var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            // get current date and time and store it in a formatting string
            var date = new Date();
            var dateStr = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getHours() + "-" + date.getMinutes() + "-" + date.getSeconds();
            
            // create a file name
            var exportFileDefaultName = 'banemasterdex-' + dateStr + '.json';
            var linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importFromJSON() {
            console.log(`Importing from JSON...`);

            var input = document.createElement('input');
            input.type = 'file';
            input.click();

            input.onchange = e => {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.readAsText(file, 'UTF-8');
                reader.onload = readerEvent => {
                    var content = readerEvent.target.result;
                    var json = JSON.parse(content);

                    // if the json does not contain a bulbasaur in the first position or doesn't even have a name key to start with, it is not a valid json file
                    if (!json[0].hasOwnProperty("name") || json[0].name != "Bulbasaur") { 
                        console.log("Invalid JSON file.");
                        return;
                    }

                    for (var i = 0; i < json.length; i++) {
                        if (json[i].obtained) {
                            let pokemon = document.querySelector("#" + json[i].name);

                            if (pokemon != null)
                                pokemon.classList.add("caught");
                            else
                                console.log("pokemon not found");
                        }
                    }

                    full_json = json;
                }
            }
        }

    </script>


</body>

</html>